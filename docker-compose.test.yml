version: '3.8'

services:
  postgres-test:
    # For dependency tests with real database schema
    #
    # LOCAL DEVELOPMENT:
    #   - Use your local database with schema already applied, OR
    #   - Use this plain PostgreSQL image for basic integration tests
    #
    # CI/CD PIPELINE:
    #   - Uncomment the custom image line below once database repo publishes images
    #   - Custom image should have schema pre-applied from database repo SQL files
    #   - Example: image: your-registry/notifications-db:latest
    #
    # Custom database image (uncomment when ready):
    # image: your-registry/notifications-db:latest

    # Default: Plain PostgreSQL 16 (no schema)
    image: postgres:18-alpine@sha256:aa6eb304ddb6dd26df23d05db4e5cb05af8951cda3e0dc57731b771e0ef4ab29

    environment:
      POSTGRES_DB: test_notifications
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      # Override these via .env.test file if needed
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis-test:
    image: redis:8-alpine@sha256:4eec4565e45aa0b3966554c866bc73211e281b0b3d89fe9a33c982e6faca809d
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  localstack:
    image: localstack/localstack:latest
    environment:
      SERVICES: sqs,s3
      DEFAULT_REGION: us-east-1
      DEBUG: 1
    ports:
      - "4566:4566"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
