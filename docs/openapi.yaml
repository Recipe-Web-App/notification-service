openapi: 3.0.3
info:
  title: Notification Service API
  description: |
    Notification service for the Recipe Web App. Handles email notifications with async queue processing.

    ## Features
    - Template-based email notifications (recipe events, social events, system notifications)
    - Async notification queue with Redis/RQ
    - OAuth2 authentication with scope-based authorization
    - Batch notification support (up to 100 recipients per request)
    - Follower-based authorization for user-to-user notifications
    - Status polling for notification delivery tracking
    - Rate limiting (100 requests/minute per user)

    ## Authorization Model
    - **notification:user** - Send notifications to followers only, read own notifications
    - **notification:admin** - Send to anyone, access all admin endpoints
    - Service accounts (recipe-management-service, user-management-service) get **notification:admin** scope

    ## Data Fetching & URL Construction
    The notification service uses a lean API design - endpoints accept only entity IDs, not full entity data.

    **Downstream Service Integration:**
    - **recipe-management-service** - Fetches recipe details, comment details, like counts
    - **user-management-service** - Fetches user details (names, emails, usernames), validates follower relationships

    **URL Construction:**
    - Service constructs frontend URLs using the `FRONTEND_BASE_URL` environment variable
    - Example: `FRONTEND_BASE_URL=https://app.example.com`
    - Generated URLs: `{FRONTEND_BASE_URL}/recipes/{recipe_id}`, `{FRONTEND_BASE_URL}/users/{username}`, etc.

    **Benefits:**
    - Ensures notification data is always fresh (no stale names/emails)
    - Reduces request payload size
    - Centralizes data ownership in appropriate services
    - Simplifies API contract

  version: 1.0.0
  contact:
    name: Recipe Web App Team
  license:
    name: MIT

servers:
  - url: http://notification-service.notification.svc.cluster.local:8000/api/v1/notification
    description: Kubernetes internal (production)
  - url: http://localhost:8000/api/v1/notification
    description: Local development

security:
  - OAuth2: []

tags:
  - name: Recipe Notifications
    description: Notifications for recipe-related events
  - name: Social Notifications
    description: Notifications for social interactions
  - name: Activity Notifications
    description: Notifications for recipe activity and engagement
  - name: System Notifications
    description: System and security notifications
  - name: Notification Management
    description: Query and manage notifications
  - name: User Notifications
    description: User-specific notification queries
  - name: Admin
    description: Administrative endpoints
  - name: Health
    description: Health check endpoints

paths:
  # Recipe Notification Endpoints
  /notifications/recipe-published:
    post:
      tags:
        - Recipe Notifications
      summary: Notify followers when a recipe is published
      description: |
        Sends email notifications to all followers of the recipe author.
        Requires **notification:admin** scope OR **notification:user** scope with valid follower relationships.

        The service fetches recipe details (name, author) from recipe-management-service and constructs URLs using FRONTEND_BASE_URL.

        Returns 202 Accepted immediately - notifications are queued for async processing.
        Use GET /notifications/{id} to poll for delivery status.
      operationId: notifyRecipePublished
      security:
        - OAuth2: ["notification:user", "notification:admin"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecipePublishedRequest'
            example:
              recipient_ids:
                - 550e8400-e29b-41d4-a716-446655440001
                - 550e8400-e29b-41d4-a716-446655440002
              recipe_id: 123
      responses:
        '202':
          description: Notifications queued successfully
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
              description: Request limit per minute
            X-RateLimit-Remaining:
              schema:
                type: integer
              description: Remaining requests in current window
            X-RateLimit-Reset:
              schema:
                type: integer
              description: Unix timestamp when rate limit resets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
              example:
                notifications:
                  - notification_id: 770e8400-e29b-41d4-a716-446655440111
                    recipient_id: 550e8400-e29b-41d4-a716-446655440001
                  - notification_id: 770e8400-e29b-41d4-a716-446655440112
                    recipient_id: 550e8400-e29b-41d4-a716-446655440002
                queued_count: 2
                message: "Notifications queued successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /notifications/recipe-liked:
    post:
      tags:
        - Recipe Notifications
      summary: Notify recipe author when someone likes their recipe
      description: |
        Sends email notification to the recipe author.
        Requires **notification:admin** scope OR **notification:user** scope with valid follower relationship.

        The service fetches recipe details from recipe-management-service and liker details from user-management-service.
      operationId: notifyRecipeLiked
      security:
        - OAuth2: ["notification:user", "notification:admin"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecipeLikedRequest'
            example:
              recipient_ids:
                - 550e8400-e29b-41d4-a716-446655440001
              recipe_id: 123
              liker_id: 550e8400-e29b-41d4-a716-446655440002
      responses:
        '202':
          description: Notification queued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /notifications/recipe-commented:
    post:
      tags:
        - Recipe Notifications
      summary: Notify recipe author when someone comments on their recipe
      description: |
        Sends email notification to the recipe author with comment preview.
        Requires **notification:admin** scope OR **notification:user** scope with valid follower relationship.

        The service fetches complete comment details (including recipe_id, commenter info, comment text) from recipe-management-service.
      operationId: notifyRecipeCommented
      security:
        - OAuth2: ["notification:user", "notification:admin"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecipeCommentedRequest'
            example:
              recipient_ids:
                - 550e8400-e29b-41d4-a716-446655440001
              comment_id: 456
      responses:
        '202':
          description: Notification queued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # Social Notification Endpoints
  /notifications/new-follower:
    post:
      tags:
        - Social Notifications
      summary: Notify user when someone follows them
      description: |
        Sends email notification to user about new follower.
        Requires **notification:admin** scope (typically called by user-management-service).

        The service fetches follower details from user-management-service and constructs profile URLs using FRONTEND_BASE_URL.
      operationId: notifyNewFollower
      security:
        - OAuth2: ["notification:admin"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewFollowerRequest'
            example:
              recipient_ids:
                - 550e8400-e29b-41d4-a716-446655440001
              follower_id: 550e8400-e29b-41d4-a716-446655440002
      responses:
        '202':
          description: Notification queued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /notifications/mention:
    post:
      tags:
        - Social Notifications
      summary: Notify user when mentioned in a comment
      description: |
        Sends email notification to user about being mentioned.
        Requires **notification:admin** scope OR **notification:user** scope with valid follower relationship.

        The service fetches complete comment details (including mentioner/commenter info, comment text, recipe context) from recipe-management-service.
      operationId: notifyMention
      security:
        - OAuth2: ["notification:user", "notification:admin"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MentionRequest'
            example:
              recipient_ids:
                - 550e8400-e29b-41d4-a716-446655440001
              comment_id: 456
      responses:
        '202':
          description: Notification queued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /notifications/share-recipe:
    post:
      tags:
        - Social Notifications
      summary: Share a recipe with users and notify the recipe author
      description: |-
        Shares a recipe with specified recipients and notifies the recipe author.
        Sends dual notifications:
        1. **To recipients**: Share notification with recipe preview (title, description, image, link)
        2. **To recipe author**: Notification that their recipe was shared

        Requires **notification:admin** scope OR **notification:user** scope with valid follower relationship.

        **Privacy Considerations:**
        - Recipients always see the sharer's identity (if provided)
        - Author notification reveals sharer identity only if:
          1. Requester has **notification:admin** scope, OR
          2. Sharer follows the recipe author (validated via user-management-service)
        - Otherwise, author receives anonymous share notification

        The service fetches:
        - Recipe details from recipe-management-service
        - Recipe images from media-management-service (gracefully degrades if unavailable)
        - User details from user-management-service
      operationId: shareRecipe
      security:
        - OAuth2: ["notification:user", "notification:admin"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShareRecipeRequest'
            example:
              recipient_ids:
                - 550e8400-e29b-41d4-a716-446655440001
                - 550e8400-e29b-41d4-a716-446655440002
              recipe_id: 123
              sharer_id: 550e8400-e29b-41d4-a716-446655440003
              share_message: "Check out this amazing recipe!"
      responses:
        '202':
          description: Notifications queued successfully (recipients + author)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
              example:
                notifications:
                  - notification_id: 770e8400-e29b-41d4-a716-446655440111
                    recipient_id: 550e8400-e29b-41d4-a716-446655440001
                  - notification_id: 770e8400-e29b-41d4-a716-446655440112
                    recipient_id: 550e8400-e29b-41d4-a716-446655440002
                  - notification_id: 770e8400-e29b-41d4-a716-446655440113
                    recipient_id: 660e8400-e29b-41d4-a716-446655440099
                queued_count: 3
                message: "Notifications queued successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /notifications/recipe-collected:
    post:
      tags:
        - Social Notifications
      summary: Notify recipe author when recipe is added to a collection
      description: |-
        Sends email notification to the recipe author when their recipe is added to a collection.
        Requires **notification:admin** scope OR **notification:user** scope with valid follower relationship.

        **Privacy Considerations:**
        - Notification is only sent if the collector's privacy settings allow it
        - Service validates that collector either has public profile or follows the recipe author

        The service fetches recipe details from recipe-management-service, collection details, and collector info from user-management-service.
        The notification includes links to the collection and the collector's profile.
      operationId: notifyRecipeCollected
      security:
        - OAuth2: ["notification:user", "notification:admin"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecipeCollectedRequest'
            example:
              recipient_ids:
                - 550e8400-e29b-41d4-a716-446655440001
              recipe_id: 123
              collector_id: 550e8400-e29b-41d4-a716-446655440002
              collection_id: 456
      responses:
        '202':
          description: Notification queued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # Activity Notification Endpoints
  /notifications/recipe-rated:
    post:
      tags:
        - Activity Notifications
      summary: Notify recipe author when someone rates their recipe
      description: |-
        Sends email notification to the recipe author when their recipe receives a rating.
        Requires **notification:admin** scope OR **notification:user** scope with valid follower relationship.

        The service fetches recipe details and rating information from recipe-management-service,
        and rater details from user-management-service.
      operationId: notifyRecipeRated
      security:
        - OAuth2: ["notification:user", "notification:admin"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecipeRatedRequest'
            example:
              recipient_ids:
                - 550e8400-e29b-41d4-a716-446655440001
              recipe_id: 123
              rater_id: 550e8400-e29b-41d4-a716-446655440002
      responses:
        '202':
          description: Notification queued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /notifications/recipe-featured:
    post:
      tags:
        - Activity Notifications
      summary: Notify recipe author when their recipe is featured
      description: |-
        Sends email notification to the recipe author when their recipe is featured by the platform.
        Requires **notification:admin** scope (system-generated notification).

        The service fetches recipe details from recipe-management-service and constructs URLs using FRONTEND_BASE_URL.
      operationId: notifyRecipeFeatured
      security:
        - OAuth2: ["notification:admin"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecipeFeaturedRequest'
            example:
              recipient_ids:
                - 550e8400-e29b-41d4-a716-446655440001
              recipe_id: 123
              featured_reason: "Editor's Choice - Outstanding presentation and clear instructions"
      responses:
        '202':
          description: Notification queued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /notifications/recipe-trending:
    post:
      tags:
        - Activity Notifications
      summary: Notify recipe author when their recipe is trending
      description: |-
        Sends email notification to the recipe author when their recipe is trending on the platform.
        Requires **notification:admin** scope (system-generated notification).

        The service fetches recipe details from recipe-management-service and constructs URLs using FRONTEND_BASE_URL.
      operationId: notifyRecipeTrending
      security:
        - OAuth2: ["notification:admin"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecipeTrendingRequest'
            example:
              recipient_ids:
                - 550e8400-e29b-41d4-a716-446655440001
              recipe_id: 123
              trending_metrics: "1,234 views and 89 likes in the past 24 hours"
      responses:
        '202':
          description: Notification queued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # System Notification Endpoints
  /notifications/password-reset:
    post:
      tags:
        - System Notifications
      summary: Send password reset email
      description: |
        Sends password reset link via email.
        Requires **notification:admin** scope (typically called by auth-service).

        The service fetches user email from user-management-service and constructs reset URL using FRONTEND_BASE_URL configuration.
      operationId: notifyPasswordReset
      security:
        - OAuth2: ["notification:admin"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordResetRequest'
            example:
              recipient_ids:
                - 550e8400-e29b-41d4-a716-446655440001
              reset_token: "abc123def456ghi789"
              expiry_hours: 24
      responses:
        '202':
          description: Notification queued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /notifications/welcome:
    post:
      tags:
        - System Notifications
      summary: Send welcome email to new users
      description: |
        Sends welcome email to newly registered users.
        Requires **service-to-service authentication** (client_credentials grant) - typically called by user-management-service when a new user registers.

        **Authorization**: This endpoint only accepts service-to-service authentication where user_id equals client_id (client_credentials grant type).
        Regular user authentication (even with admin scope) will be rejected with 403 Forbidden.

        The service fetches user details (email, username, full_name) from user-management-service and constructs app URLs using FRONTEND_BASE_URL configuration.

        **Batch Support**: Supports multiple recipients for bulk welcome operations (e.g., data migrations, bulk user imports).
      operationId: notifyWelcome
      security:
        - OAuth2: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WelcomeRequest'
            examples:
              single_user:
                summary: Welcome single user
                value:
                  recipient_ids:
                    - 550e8400-e29b-41d4-a716-446655440001
              batch_users:
                summary: Welcome multiple users (bulk operation)
                value:
                  recipient_ids:
                    - 550e8400-e29b-41d4-a716-446655440001
                    - 550e8400-e29b-41d4-a716-446655440002
                    - 550e8400-e29b-41d4-a716-446655440003
      responses:
        '202':
          description: Notifications queued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
              example:
                notifications:
                  - notification_id: 770e8400-e29b-41d4-a716-446655440111
                    recipient_id: 550e8400-e29b-41d4-a716-446655440001
                  - notification_id: 770e8400-e29b-41d4-a716-446655440112
                    recipient_id: 550e8400-e29b-41d4-a716-446655440002
                queued_count: 2
                message: "Notifications queued successfully"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - requires service-to-service authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: forbidden
                message: You do not have permission to perform this action
                detail: "Welcome notifications require service-to-service authentication"
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: not_found
                message: User not found
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /notifications/email-changed:
    post:
      tags:
        - System Notifications
      summary: Send security notification for email change
      description: |-
        Sends security notification to both old and new email addresses when a user changes their email.
        Requires **service-to-service authentication** (client_credentials grant) - typically called by user-management-service or auth-service.

        **Authorization**: This endpoint only accepts service-to-service authentication where user_id equals client_id (client_credentials grant type).
        Regular user authentication (even with admin scope) will be rejected with 403 Forbidden.

        The service sends notifications to both the old and new email addresses to alert the user of the change.
      operationId: notifyEmailChanged
      security:
        - OAuth2: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EmailChangedRequest'
            example:
              recipient_ids:
                - 550e8400-e29b-41d4-a716-446655440001
              old_email: old.email@example.com
              new_email: new.email@example.com
      responses:
        '202':
          description: Notification queued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - requires service-to-service authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: forbidden
                message: You do not have permission to perform this action
                detail: "Email change notifications require service-to-service authentication"
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /notifications/password-changed:
    post:
      tags:
        - System Notifications
      summary: Send security notification for password change
      description: |-
        Sends security notification when a user's password is changed.
        Requires **service-to-service authentication** (client_credentials grant) - typically called by auth-service.

        **Authorization**: This endpoint only accepts service-to-service authentication where user_id equals client_id (client_credentials grant type).
        Regular user authentication (even with admin scope) will be rejected with 403 Forbidden.

        The service fetches user email from user-management-service.
      operationId: notifyPasswordChanged
      security:
        - OAuth2: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordChangedRequest'
            example:
              recipient_ids:
                - 550e8400-e29b-41d4-a716-446655440001
      responses:
        '202':
          description: Notification queued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - requires service-to-service authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: forbidden
                message: You do not have permission to perform this action
                detail: "Password change notifications require service-to-service authentication"
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /notifications/maintenance:
    post:
      tags:
        - System Notifications
      summary: Send system maintenance notification
      description: |-
        Broadcasts maintenance notification about scheduled system maintenance.
        Requires **notification:admin** scope (typically sent by operations/admin team).

        **Broadcast Behavior:**
        - `adminOnly: false` (default) - Broadcasts to all users and all admins (full platform notification)
        - `adminOnly: true` - Sends only to admins (internal maintenance that doesn't impact users)

        The service automatically determines recipients based on the adminOnly flag and fetches user emails from user-management-service.
      operationId: notifyMaintenance
      security:
        - OAuth2: ["notification:admin"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MaintenanceRequest'
            examples:
              all_users:
                summary: Broadcast to all users and admins
                value:
                  adminOnly: false
                  maintenance_start: "2025-11-15T02:00:00Z"
                  maintenance_end: "2025-11-15T06:00:00Z"
                  description: "Scheduled database maintenance. The platform will be unavailable during this time."
              admins_only:
                summary: Send to admins only
                value:
                  adminOnly: true
                  maintenance_start: "2025-11-15T03:00:00Z"
                  maintenance_end: "2025-11-15T03:30:00Z"
                  description: "Backend API server restart - no user-facing impact expected."
      responses:
        '202':
          description: Notifications queued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchNotificationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # Notification Management Endpoints
  /notifications/{notificationId}:
    get:
      tags:
        - Notification Management
      summary: Get notification details and status
      description: |
        Retrieve notification details including delivery status.
        Users can only access their own notifications unless they have **notification:admin** scope.

        **Message Field**: By default, the `message` field is excluded from the response to reduce payload size.
        Use the `include_message` query parameter to include the full message body.

        Use this endpoint to poll for notification delivery status after queuing.
      operationId: getNotification
      security:
        - OAuth2: ["notification:user", "notification:admin"]
      parameters:
        - name: notificationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Notification UUID
        - name: include_message
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Include the full message body in the response (default is false to reduce payload size)
      responses:
        '200':
          description: Notification details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationDetail'
              example:
                notification_id: 770e8400-e29b-41d4-a716-446655440111
                recipient_id: 550e8400-e29b-41d4-a716-446655440001
                recipient_email: john.doe@example.com
                subject: "New Recipe: Grandma's Chocolate Chip Cookies"
                notification_type: email
                status: sent
                created_at: "2025-10-28T14:30:00Z"
                queued_at: "2025-10-28T14:30:01Z"
                sent_at: "2025-10-28T14:30:15Z"
                retry_count: 0
                max_retries: 3
                error_message: ""
                metadata:
                  template_type: recipe_published
                  recipe_id: 660e8400-e29b-41d4-a716-446655440099
        '400':
          description: Invalid notification ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "bad_request"
                message: "Invalid notification ID format"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Notification Management
      summary: Delete a notification
      description: |
        Delete a notification record. Available to:
        - **Admin users** (notification:admin scope) - Can delete any notification
        - **Notification owners** (notification:user scope) - Can delete their own notifications

        **Restrictions:**
        - Cannot delete notifications that are currently being processed (status=queued)
        - Returns 409 Conflict if attempting to delete a queued notification
      operationId: deleteNotification
      security:
        - OAuth2: ["notification:user", "notification:admin"]
      parameters:
        - name: notificationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Notification UUID
      responses:
        '204':
          description: Notification deleted successfully
        '400':
          description: Invalid notification ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "bad_request"
                message: "Invalid notification ID format"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Cannot delete notification in queued status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "conflict"
                message: "Cannot delete notification while it is being processed"
                detail: "Notification status is 'queued'"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /notifications/{notificationId}/retry:
    post:
      tags:
        - Notification Management
      summary: Retry a failed notification
      description: |
        Retry sending a failed notification. Only available for notifications with status=failed.
        Requires **notification:admin** scope.

        This endpoint retries a single notification by ID. For bulk retry operations,
        use `POST /notifications/retry-failed` instead.
      operationId: retryNotification
      security:
        - OAuth2: ["notification:admin"]
      parameters:
        - name: notificationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Notification UUID
      responses:
        '202':
          description: Notification queued for retry
          content:
            application/json:
              schema:
                type: object
                properties:
                  notification_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [queued]
                  message:
                    type: string
              example:
                notification_id: 770e8400-e29b-41d4-a716-446655440111
                status: queued
                message: "Notification queued for retry"
        '400':
          description: Invalid notification ID format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "bad_request"
                message: "Invalid notification ID format"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Conflict - Cannot retry notification
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                wrong_status:
                  summary: Notification not in failed status
                  value:
                    error: "conflict"
                    message: "Cannot retry notification that is not in failed status"
                    detail: "Current status is 'sent'"
                exhausted_retries:
                  summary: Retry limit exhausted
                  value:
                    error: "conflict"
                    message: "Cannot retry notification - retry limit exhausted"
                    detail: "Retry count (3) >= max retries (3)"
        '500':
          $ref: '#/components/responses/InternalServerError'

  # User Notification Endpoints
  /users/me/notifications:
    get:
      tags:
        - User Notifications
      summary: Get current user's notifications
      description: |
        Retrieve paginated list of notifications for the authenticated user.
        Returns notifications ordered by creation date (newest first).

        **Message Field**: By default, the `message` field is excluded from the response to reduce payload size.
        Use the `include_message` query parameter to include the full message body.
      operationId: getMyNotifications
      security:
        - OAuth2: ["notification:user", "notification:admin"]
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of items per page
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, queued, sent, failed]
          description: Filter by notification status
        - name: notification_type
          in: query
          schema:
            type: string
            enum: [email]
          description: Filter by notification type
        - name: include_message
          in: query
          schema:
            type: boolean
            default: false
          description: Include the full message body in the response (default is false to reduce payload size)
      responses:
        '200':
          description: User notifications retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationListResponse'
              example:
                results:
                  - notification_id: 770e8400-e29b-41d4-a716-446655440111
                    recipient_id: 550e8400-e29b-41d4-a716-446655440001
                    recipient_email: john.doe@example.com
                    subject: "New Recipe: Grandma's Chocolate Chip Cookies"
                    notification_type: email
                    status: sent
                    created_at: "2025-10-28T14:30:00Z"
                    queued_at: "2025-10-28T14:30:01Z"
                    sent_at: "2025-10-28T14:30:15Z"
                    retry_count: 0
                    max_retries: 3
                    error_message: ""
                    metadata:
                      template_type: recipe_published
                      recipe_id: 660e8400-e29b-41d4-a716-446655440099
                  - notification_id: 770e8400-e29b-41d4-a716-446655440112
                    recipient_id: 550e8400-e29b-41d4-a716-446655440001
                    recipient_email: john.doe@example.com
                    subject: "Someone liked your recipe!"
                    notification_type: email
                    status: sent
                    created_at: "2025-10-27T10:15:00Z"
                    queued_at: "2025-10-27T10:15:01Z"
                    sent_at: "2025-10-27T10:15:10Z"
                    retry_count: 0
                    max_retries: 3
                    error_message: ""
                    metadata:
                      template_type: recipe_liked
                      recipe_id: 660e8400-e29b-41d4-a716-446655440099
                count: 42
                next: "http://localhost:8000/api/v1/notification/users/me/notifications?page=2"
                previous: null
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "bad_request"
                message: "Invalid status filter"
                detail: "Status must be one of: pending, queued, sent, failed"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /users/{userId}/notifications:
    get:
      tags:
        - User Notifications
      summary: Get notifications for a specific user
      description: |
        Retrieve paginated list of notifications for a specific user.
        Only available to admin users.
      operationId: getUserNotifications
      security:
        - OAuth2: ["notification:admin"]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: User UUID
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of items per page
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, queued, sent, failed]
          description: Filter by notification status
        - name: notification_type
          in: query
          schema:
            type: string
            enum: [email]
          description: Filter by notification type
        - name: include_message
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Include the full message body in the response (default is false to reduce payload size)
      responses:
        '200':
          description: User notifications retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # Admin Endpoints
  /stats:
    get:
      tags:
        - Admin
      summary: Get notification statistics
      description: |
        Retrieve aggregated statistics about notifications.
        Only available to admin users.
      operationId: getNotificationStats
      security:
        - OAuth2: ["notification:admin"]
      parameters:
        - name: start_date
          in: query
          schema:
            type: string
            format: date-time
          description: Start date for statistics range
        - name: end_date
          in: query
          schema:
            type: string
            format: date-time
          description: End date for statistics range
      responses:
        '200':
          description: Statistics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationStats'
              example:
                total_notifications: 15234
                status_breakdown:
                  pending: 12
                  queued: 45
                  sent: 14987
                  failed: 190
                type_breakdown:
                  email: 15234
                success_rate: 0.9876
                average_send_time_seconds: 14.5
                failed_notifications:
                  total: 190
                  by_error_type:
                    smtp_error: 120
                    invalid_email: 45
                    timeout: 25
                retry_statistics:
                  total_retried: 145
                  currently_retrying: 23
                  exhausted_retries: 12
                  average_retries_before_success: 1.3
                  retry_success_rate: 0.91
                date_range:
                  start: "2025-10-01T00:00:00Z"
                  end: "2025-10-28T23:59:59Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /notifications/retry-failed:
    post:
      tags:
        - Admin
      summary: Retry all failed notifications
      description: |
        Queue all failed notifications for retry.
        Only available to admin users.
        Use with caution on large numbers of failed notifications.
      operationId: retryFailedNotifications
      security:
        - OAuth2: ["notification:admin"]
      parameters:
        - name: max_failures
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
          description: Maximum number of failed notifications to retry
      responses:
        '202':
          description: Failed notifications queued for retry
          content:
            application/json:
              schema:
                type: object
                properties:
                  queued_count:
                    type: integer
                    description: Number of notifications queued for retry
                  remaining_failed:
                    type: integer
                    description: Number of eligible failed notifications not retried in this batch
                  total_eligible:
                    type: integer
                    description: Total number of eligible failed notifications
                  message:
                    type: string
              example:
                queued_count: 87
                remaining_failed: 50
                total_eligible: 137
                message: "87 of 137 failed notifications queued for retry"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /notifications/retry-status:
    get:
      tags:
        - Admin
      summary: Get notification retry status
      description: |
        Get current retry status for failed notifications.
        Only available to admin users.

        This endpoint is not cached and returns real-time data, making it suitable
        for polling between retry operations.
      operationId: getNotificationRetryStatus
      security:
        - OAuth2: ["notification:admin"]
      responses:
        '200':
          description: Retry status retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  failed_retryable:
                    type: integer
                    description: Number of FAILED notifications that can still be retried (retry_count < max_retries)
                  failed_exhausted:
                    type: integer
                    description: Number of FAILED notifications that have exhausted retries (retry_count >= max_retries)
                  currently_queued:
                    type: integer
                    description: Number of notifications currently being processed (status = QUEUED)
                  safe_to_retry:
                    type: boolean
                    description: Boolean indicating if it's safe to queue more retries (true when currently_queued = 0)
              example:
                failed_retryable: 23
                failed_exhausted: 12
                currently_queued: 0
                safe_to_retry: true
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /templates:
    get:
      tags:
        - Admin
      summary: List available notification templates
      description: |
        Retrieve list of available notification templates with their required fields.
        Available to all authenticated users.
      operationId: listTemplates
      security:
        - OAuth2: ["notification:user", "notification:admin"]
      responses:
        '200':
          description: Template list retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  templates:
                    type: array
                    items:
                      $ref: '#/components/schemas/TemplateInfo'
              example:
                templates:
                  - template_type: recipe_published
                    display_name: Recipe Published
                    description: Notify followers when a new recipe is published
                    required_fields: [recipient_ids, recipe_id]
                    endpoint: /notifications/recipe-published
                  - template_type: recipe_liked
                    display_name: Recipe Liked
                    description: Notify recipe author when someone likes their recipe
                    required_fields: [recipient_ids, recipe_id, liker_id]
                    endpoint: /notifications/recipe-liked
                  - template_type: recipe_commented
                    display_name: Recipe Commented
                    description: Notify recipe author when someone comments
                    required_fields: [recipient_ids, comment_id]
                    endpoint: /notifications/recipe-commented
                  - template_type: new_follower
                    display_name: New Follower
                    description: Notify user about new follower
                    required_fields: [recipient_ids, follower_id]
                    endpoint: /notifications/new-follower
                  - template_type: mention
                    display_name: Mention
                    description: Notify user when mentioned in a comment
                    required_fields: [recipient_ids, comment_id]
                    endpoint: /notifications/mention
                  - template_type: password_reset
                    display_name: Password Reset
                    description: Send password reset link
                    required_fields: [recipient_ids, reset_token, expiry_hours]
                    endpoint: /notifications/password-reset
                  - template_type: welcome
                    display_name: Welcome
                    description: Send welcome email to newly registered users
                    required_fields: [recipient_ids]
                    endpoint: /notifications/welcome
                  - template_type: share_recipe
                    display_name: Share Recipe
                    description: Share a recipe with users and notify the recipe author
                    required_fields: [recipient_ids, recipe_id]
                    endpoint: /notifications/share-recipe
                  - template_type: recipe_collected
                    display_name: Recipe Collected
                    description: Notify recipe author when recipe is added to a collection
                    required_fields: [recipient_ids, recipe_id, collector_id, collection_id]
                    endpoint: /notifications/recipe-collected
                  - template_type: recipe_rated
                    display_name: Recipe Rated
                    description: Notify recipe author when someone rates their recipe
                    required_fields: [recipient_ids, recipe_id, rater_id]
                    endpoint: /notifications/recipe-rated
                  - template_type: recipe_featured
                    display_name: Recipe Featured
                    description: Notify recipe author when their recipe is featured
                    required_fields: [recipient_ids, recipe_id]
                    endpoint: /notifications/recipe-featured
                  - template_type: recipe_trending
                    display_name: Recipe Trending
                    description: Notify recipe author when their recipe is trending
                    required_fields: [recipient_ids, recipe_id]
                    endpoint: /notifications/recipe-trending
                  - template_type: email_changed
                    display_name: Email Changed
                    description: Security notification for email address change
                    required_fields: [recipient_ids, old_email, new_email]
                    endpoint: /notifications/email-changed
                  - template_type: password_changed
                    display_name: Password Changed
                    description: Security notification for password change
                    required_fields: [recipient_ids]
                    endpoint: /notifications/password-changed
                  - template_type: maintenance
                    display_name: Maintenance
                    description: System maintenance notification
                    required_fields: [maintenance_start, maintenance_end, description]
                    endpoint: /notifications/maintenance
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # Health Check Endpoints
  /health/ready:
    get:
      tags:
        - Health
      summary: Readiness probe
      description: |
        Kubernetes readiness probe. Checks database connectivity and critical dependencies.

        **Note**: This endpoint always returns HTTP 200, even when unhealthy.
        Check the `status` field in the response body to determine actual health state.
      operationId: readinessCheck
      security: []
      responses:
        '200':
          description: Health check completed (check response body for actual status)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                healthy:
                  summary: Service is healthy
                  value:
                    status: healthy
                    checks:
                      database: ok
                      redis: ok
                      smtp: ok
                unhealthy:
                  summary: Service is unhealthy (still returns 200)
                  value:
                    status: unhealthy
                    checks:
                      database: failed
                      redis: ok
                      smtp: degraded

  /health/live:
    get:
      tags:
        - Health
      summary: Liveness probe
      description: |
        Kubernetes liveness probe. Basic check that the service is running.
        Returns 200 if service process is alive.
      operationId: livenessCheck
      security: []
      responses:
        '200':
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [alive]
              example:
                status: alive

components:
  securitySchemes:
    OAuth2:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        OAuth2 Bearer token authentication. Obtain token from auth-service.
        Token must include appropriate scopes:
        - **notification:user** - Send to followers, read own notifications
        - **notification:admin** - Full access to all endpoints

  schemas:
    # Request Schemas
    RecipePublishedRequest:
      type: object
      required:
        - recipient_ids
        - recipe_id
      properties:
        recipient_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: List of recipient user IDs (max 100)
        recipe_id:
          type: integer
          format: int64
          description: ID of the published recipe. Service will fetch recipe details and author info from recipe-management-service.

    RecipeLikedRequest:
      type: object
      required:
        - recipient_ids
        - recipe_id
        - liker_id
      properties:
        recipient_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: List of recipient user IDs (typically the recipe author)
        recipe_id:
          type: integer
          format: int64
          description: ID of the liked recipe. Service will fetch recipe details from recipe-management-service.
        liker_id:
          type: string
          format: uuid
          description: UUID of the user who liked the recipe. Service will fetch user details from user-management-service.

    RecipeCommentedRequest:
      type: object
      required:
        - recipient_ids
        - comment_id
      properties:
        recipient_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: List of recipient user IDs (typically the recipe author)
        comment_id:
          type: integer
          format: int64
          description: ID of the comment. Service will fetch comment details (including recipe_id and commenter info) from recipe-management-service.

    NewFollowerRequest:
      type: object
      required:
        - recipient_ids
        - follower_id
      properties:
        recipient_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: List of recipient user IDs (user being followed)
        follower_id:
          type: string
          format: uuid
          description: UUID of the new follower. Service will fetch follower details from user-management-service.

    MentionRequest:
      type: object
      required:
        - recipient_ids
        - comment_id
      properties:
        recipient_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: List of recipient user IDs (users mentioned in comment)
        comment_id:
          type: integer
          format: int64
          description: ID of the comment containing the mention. Service will fetch comment details (including commenter/mentioner info, context, recipe_id) from recipe-management-service.

    PasswordResetRequest:
      type: object
      required:
        - recipient_ids
        - reset_token
        - expiry_hours
      properties:
        recipient_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 1
          description: Single recipient (user requesting reset). Service will fetch user email from user-management-service.
        reset_token:
          type: string
          minLength: 20
          description: Secure reset token. Service will construct reset URL using FRONTEND_BASE_URL configuration.
        expiry_hours:
          type: integer
          minimum: 1
          maximum: 72
          description: Number of hours until token expires

    WelcomeRequest:
      type: object
      required:
        - recipient_ids
      properties:
        recipient_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          description: List of recipient user IDs (newly registered users). Service will fetch user details (email, username, full_name) from user-management-service. Supports batch operations for bulk user imports.

    ShareRecipeRequest:
      type: object
      required:
        - recipient_ids
        - recipe_id
      properties:
        recipient_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: List of user IDs to share the recipe with. Recipients always see sharer identity. An additional notification is sent to the recipe author.
        recipe_id:
          type: integer
          format: int64
          description: ID of the recipe to share. Service will fetch recipe details and images from recipe-management-service and media-management-service.
        sharer_id:
          type: string
          format: uuid
          nullable: true
          description: Optional UUID of the user sharing the recipe. Always revealed to recipients. Only revealed to recipe author if sharer follows author or requester has admin scope. Service will fetch sharer details from user-management-service.
        share_message:
          type: string
          nullable: true
          maxLength: 500
          description: Optional message from the sharer included in both recipient and author notifications

    RecipeCollectedRequest:
      type: object
      required:
        - recipient_ids
        - recipe_id
        - collector_id
        - collection_id
      properties:
        recipient_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: List of recipient user IDs (typically the recipe author)
        recipe_id:
          type: integer
          format: int64
          description: ID of the recipe added to collection. Service will fetch recipe details from recipe-management-service.
        collector_id:
          type: string
          format: uuid
          description: UUID of the user who added the recipe to their collection. Service will fetch collector details from user-management-service.
        collection_id:
          type: integer
          format: int64
          description: ID of the collection. Service will fetch collection details from recipe-management-service. Notification includes links to collection and collector profile.

    RecipeRatedRequest:
      type: object
      required:
        - recipient_ids
        - recipe_id
        - rater_id
      properties:
        recipient_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: List of recipient user IDs (typically the recipe author)
        recipe_id:
          type: integer
          format: int64
          description: ID of the rated recipe. Service will fetch recipe details and rating information from recipe-management-service.
        rater_id:
          type: string
          format: uuid
          description: UUID of the user who rated the recipe. Service will fetch rater details from user-management-service.

    RecipeFeaturedRequest:
      type: object
      required:
        - recipient_ids
        - recipe_id
      properties:
        recipient_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: List of recipient user IDs (recipe authors being notified their recipe is featured)
        recipe_id:
          type: integer
          format: int64
          description: ID of the featured recipe. Service will fetch recipe details from recipe-management-service.
        featured_reason:
          type: string
          nullable: true
          maxLength: 500
          description: Optional reason or category for featuring (e.g., "Editor's Choice", "Top Rated", "Seasonal Favorite")

    RecipeTrendingRequest:
      type: object
      required:
        - recipient_ids
        - recipe_id
      properties:
        recipient_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: List of recipient user IDs (recipe authors being notified their recipe is trending)
        recipe_id:
          type: integer
          format: int64
          description: ID of the trending recipe. Service will fetch recipe details from recipe-management-service.
        trending_metrics:
          type: string
          nullable: true
          maxLength: 500
          description: Optional trending metrics summary (e.g., "1,234 views and 89 likes in the past 24 hours")

    EmailChangedRequest:
      type: object
      required:
        - recipient_ids
        - old_email
        - new_email
      properties:
        recipient_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 1
          description: Single recipient (user whose email changed). Notifications sent to both old and new email addresses.
        old_email:
          type: string
          format: email
          description: Previous email address (notification sent here as security measure)
        new_email:
          type: string
          format: email
          description: New email address (notification sent here for confirmation)

    PasswordChangedRequest:
      type: object
      required:
        - recipient_ids
      properties:
        recipient_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
          description: List of recipient user IDs (users whose password changed). Service will fetch user email from user-management-service. Supports batch operations for security events.

    MaintenanceRequest:
      type: object
      required:
        - maintenance_start
        - maintenance_end
        - description
      properties:
        adminOnly:
          type: boolean
          default: false
          description: "If true, send notification only to admins. If false (default), broadcast to all users and admins. Service determines recipients based on this flag and fetches user emails from user-management-service."
        maintenance_start:
          type: string
          format: date-time
          description: Scheduled start time of maintenance window (ISO 8601 format)
        maintenance_end:
          type: string
          format: date-time
          description: Scheduled end time of maintenance window (ISO 8601 format)
        description:
          type: string
          maxLength: 1000
          description: Description of the maintenance work and expected impact

    # Response Schemas
    BatchNotificationResponse:
      type: object
      required:
        - notifications
        - queued_count
        - message
      properties:
        notifications:
          type: array
          items:
            type: object
            required:
              - notification_id
              - recipient_id
            properties:
              notification_id:
                type: string
                format: uuid
                description: UUID of the created notification
              recipient_id:
                type: string
                format: uuid
                description: UUID of the recipient user
          description: List of created notifications mapped to recipients
        queued_count:
          type: integer
          description: Number of notifications successfully queued
        message:
          type: string

    NotificationDetail:
      type: object
      required:
        - notification_id
        - recipient_email
        - subject
        - notification_type
        - status
        - created_at
        - retry_count
        - max_retries
      properties:
        notification_id:
          type: string
          format: uuid
        recipient_id:
          type: string
          format: uuid
          nullable: true
          description: Recipient user ID (null for email-only notifications)
        recipient_email:
          type: string
          format: email
        subject:
          type: string
        message:
          type: string
          nullable: true
          description: Message body (excluded by default to reduce payload size - use include_message query parameter to retrieve)
        notification_type:
          type: string
          enum: [email]
          description: Notification delivery type (implementation uses string validation, not strict enum)
        status:
          type: string
          enum: [pending, queued, sent, failed]
          description: Current notification status (implementation uses string validation, not strict enum)
        error_message:
          type: string
          description: Error message if status is failed (empty string when no error)
        retry_count:
          type: integer
          minimum: 0
        max_retries:
          type: integer
        created_at:
          type: string
          format: date-time
        queued_at:
          type: string
          format: date-time
          nullable: true
        sent_at:
          type: string
          format: date-time
          nullable: true
        failed_at:
          type: string
          format: date-time
          nullable: true
        metadata:
          type: object
          additionalProperties: true
          description: Template-specific metadata

    NotificationListResponse:
      type: object
      required:
        - results
        - count
        - next
        - previous
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/NotificationDetail'
        count:
          type: integer
          description: Total number of notifications matching filters
        next:
          type: string
          format: uri
          nullable: true
          description: URL to next page
        previous:
          type: string
          format: uri
          nullable: true
          description: URL to previous page

    NotificationStats:
      type: object
      properties:
        total_notifications:
          type: integer
        status_breakdown:
          type: object
          properties:
            pending:
              type: integer
            queued:
              type: integer
            sent:
              type: integer
            failed:
              type: integer
        type_breakdown:
          type: object
          properties:
            email:
              type: integer
        success_rate:
          type: number
          format: float
          description: Success rate (sent / total)
        average_send_time_seconds:
          type: number
          format: float
          description: Average time from queued to sent
        failed_notifications:
          type: object
          properties:
            total:
              type: integer
            by_error_type:
              type: object
              additionalProperties:
                type: integer
        retry_statistics:
          type: object
          properties:
            total_retried:
              type: integer
              description: Total number of notifications that have been retried (retry_count > 0)
            currently_retrying:
              type: integer
              description: Number of FAILED notifications that can still be retried
            exhausted_retries:
              type: integer
              description: Number of FAILED notifications that have exhausted retries
            average_retries_before_success:
              type: number
              format: float
              description: Average retry_count for successfully sent notifications
            retry_success_rate:
              type: number
              format: float
              description: Success rate for retried notifications (sent with retries / total retried)
        date_range:
          type: object
          properties:
            start:
              type: string
              format: date-time
            end:
              type: string
              format: date-time

    TemplateInfo:
      type: object
      properties:
        template_type:
          type: string
        display_name:
          type: string
        description:
          type: string
        required_fields:
          type: array
          items:
            type: string
        endpoint:
          type: string
          description: API endpoint for this template

    HealthResponse:
      type: object
      required:
        - status
        - checks
      properties:
        status:
          type: string
          enum: [healthy, unhealthy, degraded]
        checks:
          type: object
          properties:
            database:
              type: string
              enum: [ok, failed, degraded]
            redis:
              type: string
              enum: [ok, failed, degraded]
            smtp:
              type: string
              enum: [ok, failed, degraded]

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Human-readable error message
        detail:
          type: string
          description: Additional error details
        errors:
          type: object
          additionalProperties: true
          description: Field-specific validation errors

  responses:
    BadRequest:
      description: Bad request - invalid parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: bad_request
            message: Invalid request parameters
            errors:
              recipient_ids: "Array must contain at least 1 item"

    Unauthorized:
      description: Unauthorized - missing or invalid token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: unauthorized
            message: Authentication credentials were not provided or are invalid

    Forbidden:
      description: Forbidden - insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: forbidden
            message: You do not have permission to perform this action
            detail: "Requires notification:admin scope or valid follower relationship"

    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: not_found
            message: The requested resource was not found

    RateLimitExceeded:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          schema:
            type: integer
          description: Request limit per minute
        X-RateLimit-Remaining:
          schema:
            type: integer
          description: Remaining requests (0)
        X-RateLimit-Reset:
          schema:
            type: integer
          description: Unix timestamp when rate limit resets
        Retry-After:
          schema:
            type: integer
          description: Seconds until rate limit resets
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: rate_limit_exceeded
            message: Rate limit exceeded. Please try again later.
            detail: "Limit: 100 requests per minute"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: internal_server_error
            message: An unexpected error occurred. Please try again later.
