# Pre-commit Setup Guide

This document provides comprehensive instructions for setting up and using pre-commit hooks in the notification-service project.

## Table of Contents

- [What is Pre-commit?](#what-is-pre-commit)
- [Installation](#installation)
- [First-Time Setup](#first-time-setup)
- [Usage](#usage)
- [Available Hooks](#available-hooks)
- [Configuration](#configuration)
- [Troubleshooting](#troubleshooting)
- [Best Practices](#best-practices)

---

## What is Pre-commit?

Pre-commit is a framework for managing and maintaining multi-language pre-commit hooks. It runs checks automatically before each commit to ensure code quality, security, and consistency.

### Benefits

- ✅ **Automatic code formatting** - Ruff and isort format your code
- ✅ **Early bug detection** - Catch issues before they reach code review
- ✅ **Security scanning** - Detect vulnerabilities and secrets
- ✅ **Documentation enforcement** - Ensure proper docstrings (80% coverage)
- ✅ **Infrastructure validation** - Check Dockerfiles and Kubernetes manifests
- ✅ **Shell script linting** - Validate bash scripts
- ✅ **Consistent code quality** - Same checks for all contributors
- ✅ **Fast feedback** - Issues caught in seconds, not hours

---

## Installation

### Prerequisites

- Python 3.14+
- Poetry
- Git

### Install Pre-commit

```bash
# Install all dev dependencies (includes pre-commit)
poetry install

# Or install pre-commit specifically
poetry add --group dev pre-commit
```

---

## First-Time Setup

### 1. Install Git Hooks

```bash
# Install pre-commit hook (runs before commits)
poetry run pre-commit install

# Install commit-msg hook (validates commit messages)
poetry run pre-commit install --hook-type commit-msg
```

### 2. Run on All Files (Initial Setup)

```bash
# Run all hooks on all files
poetry run pre-commit run --all-files
```

**Note:** The first run will:
- Download and cache all hook dependencies
- Check all files in the repository
- Auto-format code with Ruff format and isort
- Auto-fix many linting issues with Ruff
- Report any issues that need manual fixing

**Expected output:** Many files may be reformatted on first run. This is normal!

### 3. Fix Any Issues

If hooks find issues:

```bash
# Ruff and isort will auto-fix most issues (formatting, imports, some linting)
# For other issues, review the output and fix manually

# Run again after fixes
poetry run pre-commit run --all-files
```

### 4. Commit the Changes

```bash
# Add the formatted files
git add .

# Commit with a conventional commit message
git commit -m "chore: setup pre-commit hooks and format code"
```

---

## Usage

### Automatic Usage (Recommended)

Once installed, hooks run automatically on `git commit`:

```bash
# Make changes
vim notification_service/views.py

# Stage changes
git add notification_service/views.py

# Commit - hooks run automatically!
git commit -m "feat: add new notification endpoint"
```

### Manual Usage

Run hooks manually without committing:

```bash
# Run on all files
poetry run pre-commit run --all-files

# Run on staged files only
poetry run pre-commit run

# Run specific hook
poetry run pre-commit run ruff-format
poetry run pre-commit run ruff-check
poetry run pre-commit run bandit
poetry run pre-commit run shellcheck
poetry run pre-commit run hadolint-docker
```

### Skipping Hooks (Not Recommended)

In rare cases, you may need to skip hooks:

```bash
# Skip all hooks
git commit --no-verify -m "emergency hotfix"

# Better: Fix the issues instead!
```

**Warning:** Only skip hooks for emergency situations. Address issues properly.

---

## Available Hooks

### File Quality Checks (Fast)

- **trailing-whitespace** - Remove trailing whitespace
- **end-of-file-fixer** - Ensure files end with newline
- **mixed-line-ending** - Enforce LF line endings
- **check-yaml** - Validate YAML syntax
- **check-json** - Validate JSON syntax
- **check-toml** - Validate TOML syntax
- **check-merge-conflict** - Detect merge conflict markers
- **check-added-large-files** - Prevent large files (>500KB)
- **detect-private-key** - Prevent committing private keys
- **check-ast** - Validate Python syntax
- **check-builtin-literals** - Check for builtin literal usage
- **check-docstring-first** - Ensure docstrings come first
- **debug-statements** - Check for debugger imports

### Python Formatting (Auto-fix)

- **ruff-format** - Format Python code (replaces black)
  - Fast Python formatter
  - Line length: 88
  - Django-aware
- **isort** - Organize imports (Django-aware)
  - Groups: future, stdlib, django, third-party, first-party, local

### Python Linting

- **ruff-check** - Comprehensive Python linting (replaces flake8, pylint, and many others)
  - Combines rules from: pycodestyle, pyflakes, pep8-naming, pydocstyle, pyupgrade, flake8-bugbear, flake8-django, and more
  - Fast Rust-based linter
  - Auto-fixes many issues
  - Max line length: 88
- **mypy** - Static type checking
  - Django stubs included
  - Target: Python 3.14

### Documentation Quality

- **pydocstyle** - Docstring convention checker (Google style)
- **interrogate** - Docstring coverage (minimum 80%)
  - Fails if documentation coverage < 80%

### Security

- **bandit** - Python security scanner
  - Severity: medium+
  - Excludes: tests, migrations
- **osv-scanner** - Dependency vulnerability scanner (Google OSV)
  - Checks poetry.lock for known vulnerabilities
  - Configuration: osv-scanner.toml

### Python Modernization

- **pyupgrade** - Upgrade Python syntax to modern patterns
  - Target: Python 3.14+
  - Auto-fixes: Type hints, f-strings, dict merging, etc.

### Django Specific

- **django-upgrade** - Upgrade Django code patterns
  - Target: Django 5.2

### Infrastructure & DevOps

- **shellcheck** - Shell script linting
  - Checks bash scripts in scripts/ directory
  - Detects common shell scripting issues
  - Severity: warning+
- **hadolint-docker** - Dockerfile linting
  - Best practices for Dockerfiles
  - Security and optimization checks
  - Ignores: DL3008, DL3013
- **kube-linter** - Kubernetes best practices linting
  - Security and reliability checks
  - Configuration: .kube-linter.yaml
  - Validates Kubernetes manifests for best practices

### Dependency Management

- **poetry-check** - Validate pyproject.toml
- **poetry-lock-check** - Ensure poetry.lock is synced

### Commit Messages

- **commitizen** - Enforce conventional commits
  - Format: `<type>(<scope>): <description>`
  - Types: feat, fix, docs, style, refactor, test, chore

---

## Configuration

### Tool Configurations

All tool configurations are in `pyproject.toml`:

#### Ruff

```toml
[tool.ruff]
target-version = "py314"
line-length = 88

[tool.ruff.lint]
select = [
    "E",      # pycodestyle errors
    "W",      # pycodestyle warnings
    "F",      # pyflakes
    "N",      # pep8-naming
    "D",      # pydocstyle (docstrings)
    "UP",     # pyupgrade (modern Python syntax)
    "B",      # flake8-bugbear
    "C4",     # flake8-comprehensions
    "DJ",     # flake8-django
    "SIM",    # flake8-simplify
    "TCH",    # flake8-type-checking
    "ARG",    # flake8-unused-arguments
    "PTH",    # flake8-use-pathlib
    "ERA",    # eradicate (commented-out code)
    "PL",     # pylint
    "RUF",    # Ruff-specific rules
]

[tool.ruff.lint.pydocstyle]
convention = "google"  # Google-style docstrings
```

#### isort

```toml
[tool.isort]
profile = "black"
line_length = 88
known_django = ["django"]
sections = ["FUTURE", "STDLIB", "DJANGO", "THIRDPARTY", "FIRSTPARTY", "LOCALFOLDER"]
```

#### MyPy

```toml
[tool.mypy]
python_version = "3.14"
plugins = ["mypy_django_plugin.main"]
```

#### Pydocstyle (Docstring Style)

```toml
[tool.pydocstyle]
convention = "google"  # Google-style docstrings
```

**Example Google-style docstring:**

```python
def send_notification(recipient: str, message: str) -> bool:
    """Send a notification to a recipient.

    Args:
        recipient: Email address of the recipient.
        message: Notification message content.

    Returns:
        True if notification was sent successfully, False otherwise.

    Raises:
        ValueError: If recipient email is invalid.
    """
    pass
```

#### Interrogate (Docstring Coverage)

```toml
[tool.interrogate]
fail-under = 80  # Require 80% documentation coverage
```

#### Bandit (Security)

```toml
[tool.bandit]
exclude_dirs = ["tests", "migrations"]
```

### Customizing Hooks

Edit `.pre-commit-config.yaml` to:
- Enable/disable specific hooks
- Adjust hook arguments
- Change hook versions

### Adjusting Strictness

#### Make Stricter

1. **Increase docstring coverage:**
   ```toml
   [tool.interrogate]
   fail-under = 95  # Require 95% coverage
   ```

2. **Enable strict type checking:**
   ```toml
   [tool.mypy]
   disallow_untyped_defs = true
   ```

3. **Lower bandit severity:**
   ```yaml
   - id: bandit
     args: [--severity-level=low]
   ```

#### Make More Lenient

1. **Decrease docstring coverage:**
   ```toml
   [tool.interrogate]
   fail-under = 60  # Require 60% coverage
   ```

2. **Disable specific pylint checks:**
   ```toml
   [tool.pylint.messages_control]
   disable = ["C0111", "R0903"]
   ```

---

## Troubleshooting

### Common Issues

#### Hook Fails: "Command not found"

**Cause:** Pre-commit environment needs to be recreated.

**Solution:**
```bash
poetry run pre-commit clean
poetry run pre-commit install --install-hooks
```

#### osv-scanner Check Fails

**Cause:** Vulnerable dependencies detected.

**Solution:**
```bash
# View detailed vulnerability report
osv-scanner scan --lockfile=poetry.lock:poetry.lock

# Update vulnerable dependencies
poetry update <package-name>

# Or suppress in osv-scanner.toml (with justification and expiry date)
# See osv-scanner.toml for examples
```

#### Interrogate Fails: "Documentation coverage below 80%"

**Cause:** Missing docstrings in code.

**Solution:**
```bash
# Find files missing docstrings
poetry run interrogate --verbose notification_service/

# Add Google-style docstrings to functions, classes, and methods
```

#### Ruff Formatting Issues

**Cause:** Formatting conflicts or errors.

**Solution:**
```bash
# Run Ruff formatter
poetry run ruff format .

# Run Ruff linter with auto-fix
poetry run ruff check --fix .

# Ruff handles both formatting and linting consistently
```

#### MyPy Type Errors

**Cause:** Type annotations missing or incorrect.

**Solution:**
```bash
# Run mypy to see specific errors
poetry run mypy notification_service/

# Add type annotations
# Or add "# type: ignore" comments (sparingly)
```

#### Poetry Lock is Out of Sync

**Cause:** pyproject.toml changed without updating poetry.lock.

**Solution:**
```bash
# Update lock file
poetry lock --no-update

# Or update dependencies
poetry update
```

### Hook-Specific Debugging

```bash
# Run a specific hook with verbose output
poetry run pre-commit run <hook-id> --verbose --all-files

# Example: Debug ruff-check
poetry run pre-commit run ruff-check --verbose --all-files

# Example: Debug shellcheck
poetry run pre-commit run shellcheck --verbose --all-files
```

---

## Best Practices

### Development Workflow

1. **Make changes**
2. **Stage files** (`git add`)
3. **Commit** - hooks run automatically
4. **Fix any issues** reported by hooks
5. **Commit again**

### Writing Good Docstrings

Use Google-style docstrings consistently:

```python
class NotificationService:
    """Service for managing notifications.

    This service handles creating, sending, and tracking notifications
    across multiple channels (email, SMS, push).

    Attributes:
        default_channel: Default notification channel to use.
        retry_attempts: Number of times to retry failed notifications.
    """

    def __init__(self, default_channel: str = "email"):
        """Initialize the notification service.

        Args:
            default_channel: Default channel for notifications.
        """
        self.default_channel = default_channel

    def send(self, recipient: str, message: str) -> bool:
        """Send a notification to a recipient.

        Args:
            recipient: Email address or phone number.
            message: Notification message content.

        Returns:
            True if sent successfully, False otherwise.

        Raises:
            ValueError: If recipient format is invalid.
            ConnectionError: If notification service is unavailable.
        """
        pass
```

### Handling Auto-formatting

Ruff format and isort may reformat your code:

```bash
# After committing, files may be modified
# These are formatting changes - just add them

git add .
git commit --amend --no-edit
```

### Commit Message Format

Follow conventional commits:

```bash
# Good examples
git commit -m "feat: add email notification endpoint"
git commit -m "fix: resolve database migration conflict"
git commit -m "docs: update API documentation"
git commit -m "refactor: simplify notification logic"
git commit -m "test: add tests for SMS delivery"
git commit -m "chore: update dependencies"

# Bad examples (will be rejected)
git commit -m "fixed stuff"
git commit -m "WIP"
git commit -m "asdf"
```

### Updating Hooks

Keep hooks up to date:

```bash
# Update hook versions automatically
poetry run pre-commit autoupdate

# Review changes
git diff .pre-commit-config.yaml

# Test updated hooks
poetry run pre-commit run --all-files

# Commit updates
git add .pre-commit-config.yaml
git commit -m "chore: update pre-commit hooks"
```

---

## Performance Tips

### Speed Up Hook Execution

1. **Only commit frequently changed files** - Hooks run faster on fewer files
2. **Use `fail_fast: true`** in `.pre-commit-config.yaml` to stop on first failure
3. **Skip slow hooks in emergency** - `SKIP=mypy git commit ...`
4. **Cache is automatic** - First run is slow, subsequent runs are fast

### Skipping Specific Hooks

```bash
# Skip all hooks (emergency only)
git commit --no-verify

# Skip specific hooks
SKIP=mypy,kube-linter git commit -m "..."

# Skip only slow hooks
SKIP=mypy,osv-scanner,kube-linter git commit -m "..."
```

---

## Additional Resources

### General
- [Pre-commit Documentation](https://pre-commit.com/)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [Google Python Style Guide](https://google.github.io/styleguide/pyguide.html)

### Python Tools
- [Ruff Documentation](https://docs.astral.sh/ruff/)
- [MyPy Documentation](https://mypy.readthedocs.io/)
- [Bandit Documentation](https://bandit.readthedocs.io/)

### Infrastructure Tools
- [Shellcheck Documentation](https://www.shellcheck.net/)
- [Hadolint Documentation](https://github.com/hadolint/hadolint)
- [Kube-linter Documentation](https://docs.kubelinter.io/)

---

## Summary

### Quick Commands

```bash
# Install hooks
poetry run pre-commit install
poetry run pre-commit install --hook-type commit-msg

# Run manually
poetry run pre-commit run --all-files

# Update hooks
poetry run pre-commit autoupdate

# Clean and reinstall
poetry run pre-commit clean
poetry run pre-commit install --install-hooks
```

### What Gets Checked

✅ Code formatting (Ruff format, isort)
✅ Code quality (Ruff check, mypy)
✅ Documentation (pydocstyle, interrogate)
✅ Security (bandit, osv-scanner)
✅ Django best practices (django-upgrade)
✅ Infrastructure (shellcheck, hadolint, kube-linter)
✅ Dependencies (poetry check)
✅ Commit messages (commitizen)

---

**Happy coding with confidence!** 🚀
